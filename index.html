<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RS Dashboard ‚Äî Relative Strength vs SPY</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0a0f;
    --bg-card: #12121a;
    --bg-card-alt: #16161f;
    --bg-hover: #1e1e2a;
    --border: #2a2a3a;
    --text-primary: #e8e8f0;
    --text-secondary: #8888a0;
    --text-muted: #55556a;
    --green-strong: #00e676;
    --green-mid: #4caf50;
    --blue: #448aff;
    --yellow: #ffd740;
    --red: #ff5252;
    --accent: #00e676;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg-primary); color: var(--text-primary);
    font-family: 'Outfit', sans-serif; min-height: 100vh; overflow-x: hidden;
  }
  .noise-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }
  .glow-orb { position: fixed; border-radius: 50%; filter: blur(120px); pointer-events: none; z-index: 0; }
  .glow-orb-1 { top: -10%; right: -5%; width: 500px; height: 500px; background: rgba(0,230,118,0.04); }
  .glow-orb-2 { bottom: -10%; left: -5%; width: 400px; height: 400px; background: rgba(68,138,255,0.03); }
  .container { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 24px 20px; }

  .header {
    text-align: center; margin-bottom: 32px; padding: 40px 24px;
    background: linear-gradient(135deg, var(--bg-card) 0%, rgba(0,230,118,0.03) 100%);
    border: 1px solid var(--border); border-radius: 20px; position: relative; overflow: hidden;
  }
  .header::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,transparent,var(--accent),transparent); }
  .header h1 {
    font-weight: 900; font-size: 2.4rem; letter-spacing: -1px;
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header .subtitle { font-size: 0.95rem; color: var(--text-secondary); margin-top: 8px; font-weight: 300; }
  .header .benchmark-info {
    display: inline-flex; align-items: center; gap: 12px; margin-top: 16px;
    padding: 8px 20px; background: rgba(0,230,118,0.06); border: 1px solid rgba(0,230,118,0.15);
    border-radius: 100px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent);
  }
  .pulse-dot { width:8px; height:8px; background:var(--accent); border-radius:50%; animation:pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,230,118,0.4)} 50%{opacity:0.7;box-shadow:0 0 0 8px rgba(0,230,118,0)} }

  .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 28px; }
  .stat-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
    padding: 18px 20px; text-align: center; transition: all 0.3s ease;
  }
  .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .stat-card .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1.6rem; font-weight: 700; }
  .stat-card .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 4px; }

  .filters { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
  .filter-btn {
    padding: 8px 18px; border: 1px solid var(--border); border-radius: 100px;
    background: transparent; color: var(--text-secondary); font-family: 'Outfit', sans-serif;
    font-size: 0.85rem; cursor: pointer; transition: all 0.25s ease;
  }
  .filter-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
  .filter-btn.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); font-weight: 600; }

  .sort-row { display:flex; align-items:center; gap:8px; margin-bottom:14px; font-size:0.8rem; color:var(--text-muted); }
  .sort-row select {
    background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);
    border-radius: 8px; padding: 6px 12px; font-family: 'Outfit', sans-serif; font-size: 0.8rem; cursor: pointer;
  }

  .table-wrapper { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
  thead th {
    background: var(--bg-card-alt); color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
    text-transform: uppercase; letter-spacing: 1.2px;
    padding: 14px 12px; text-align: center; font-weight: 600;
    border-bottom: 1px solid var(--border); white-space: nowrap;
  }
  tbody tr { border-bottom: 1px solid rgba(42,42,58,0.5); transition: background 0.2s ease; }
  tbody tr:hover { background: var(--bg-hover); }
  tbody td {
    padding: 12px; text-align: center; font-family: 'JetBrains Mono', monospace;
    font-size: 0.82rem; white-space: nowrap;
  }
  .rank-cell { font-weight: 700; font-size: 0.9rem; width: 50px; }
  .rank-top3 { color: var(--accent); }
  .ticker-cell { font-weight: 700; color: var(--text-primary); font-size: 0.9rem; text-align: left; padding-left: 16px; }
  .category-cell { font-family: 'Outfit', sans-serif; font-size: 0.78rem; color: var(--text-secondary); text-align: left; }

  .rs-bar-cell { width: 130px; padding: 12px 8px; }
  .rs-bar-container { width:100%; height:22px; background:rgba(255,255,255,0.04); border-radius:4px; overflow:hidden; }
  .rs-bar { height:100%; border-radius:4px; transition:width 0.8s cubic-bezier(0.22,1,0.36,1); position:relative; }
  .rs-bar::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(180deg,rgba(255,255,255,0.15) 0%,transparent 100%); border-radius:4px; }

  .rs-value { font-weight: 600; }
  .rs-positive { color: var(--green-strong); }
  .rs-negative { color: var(--red); }
  .rs-neutral { color: var(--yellow); }

  .pctl-badge { display:inline-block; padding:3px 10px; border-radius:6px; font-weight:600; font-size:0.78rem; min-width:48px; }
  .pctl-strong { background:rgba(0,230,118,0.15); color:var(--green-strong); }
  .pctl-positive { background:rgba(68,138,255,0.15); color:var(--blue); }
  .pctl-neutral { background:rgba(255,215,64,0.12); color:var(--yellow); }
  .pctl-weak { background:rgba(255,82,82,0.12); color:var(--red); }

  .signal-badge {
    display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:100px;
    font-family:'Outfit',sans-serif; font-size:0.78rem; font-weight:600;
  }
  .signal-fuerte { background:rgba(0,230,118,0.1); color:var(--green-strong); border:1px solid rgba(0,230,118,0.2); }
  .signal-positivo { background:rgba(68,138,255,0.1); color:var(--blue); border:1px solid rgba(68,138,255,0.2); }
  .signal-neutral { background:rgba(255,215,64,0.08); color:var(--yellow); border:1px solid rgba(255,215,64,0.15); }
  .signal-debil { background:rgba(255,82,82,0.08); color:var(--red); border:1px solid rgba(255,82,82,0.15); }
  .signal-dot { width:6px; height:6px; border-radius:50%; }
  .dot-fuerte { background:var(--green-strong); box-shadow:0 0 6px var(--green-strong); }
  .dot-positivo { background:var(--blue); box-shadow:0 0 6px var(--blue); }
  .dot-neutral { background:var(--yellow); box-shadow:0 0 6px var(--yellow); }
  .dot-debil { background:var(--red); box-shadow:0 0 6px var(--red); }

  .loading { text-align:center; padding:80px 20px; }
  .loading-spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto 16px; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { color:var(--text-muted); font-size:0.9rem; }
  .error-msg { text-align:center; padding:60px 20px; color:var(--red); }
  .last-update { text-align:center; margin-top:20px; font-size:0.75rem; color:var(--text-muted); font-family:'JetBrains Mono',monospace; }
  .fade-row { opacity:0; animation:fadeIn 0.4s ease forwards; }
  @keyframes fadeIn { to{opacity:1} }

  @media (max-width: 900px) {
    .header h1 { font-size: 1.6rem; }
    .table-wrapper { overflow-x: auto; }
    table { min-width: 900px; }
    .container { padding: 12px 10px; }
  }
</style>
</head>
<body>

<div class="noise-overlay"></div>
<div class="glow-orb glow-orb-1"></div>
<div class="glow-orb glow-orb-2"></div>

<div class="container">
  <div class="header">
    <h1>‚ö° RS Dashboard</h1>
    <div class="subtitle">Relative Strength vs SPY ‚Äî Datos en vivo desde Google Sheets + GOOGLEFINANCE</div>
    <div class="benchmark-info">
      <div class="pulse-dot"></div>
      <span id="benchmark-text">Cargando datos...</span>
    </div>
  </div>
  <div class="stats-bar" id="stats-bar"></div>
  <div class="filters" id="filters"></div>
  <div class="sort-row">
    <span>Ordenar por:</span>
    <select id="sort-select">
      <option value="rank">Rank (RS Score)</option>
      <option value="rs1m">RS 1M</option>
      <option value="rs3m">RS 3M</option>
      <option value="rs12m">RS 12M</option>
      <option value="pctl">Percentil</option>
      <option value="ticker">Ticker A-Z</option>
    </select>
  </div>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>RS</th>
          <th>Ticker</th>
          <th>Categor√≠a</th>
          <th>RS 1M</th>
          <th>RS 3M</th>
          <th>RS 6M</th>
          <th>RS 12M</th>
          <th>RS Score</th>
          <th>Pctl</th>
          <th>Se√±al</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr><td colspan="11" class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">Cargando datos desde Google Sheets...</div>
        </td></tr>
      </tbody>
    </table>
  </div>
  <div class="last-update" id="last-update"></div>
</div>

<script>
const CSV_URL_RAW = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5uGhOzwIrat1XzG3IW0f_KOHywLJVWLQr6vSkAg2e2cKjX8lXB8iupdXf4zTlSA/pub?gid=1683781233&single=true&output=csv';
const CSV_URL = 'https://corsproxy.io/?' + encodeURIComponent(CSV_URL_RAW);

let allData = [];
let activeFilter = 'Todos';
let currentSort = 'rank';

function parseCSV(text) {
  const rows = [];
  const lines = text.split('\n');
  for (const line of lines) {
    const cols = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') { inQuotes = !inQuotes; }
      else if (ch === ',' && !inQuotes) { cols.push(current.trim()); current = ''; }
      else { current += ch; }
    }
    cols.push(current.trim());
    rows.push(cols);
  }
  return rows;
}

// Parsea n√∫meros en formato espa√±ol: "$140,21" ‚Üí 140.21 / "-2,50" ‚Üí -2.50
function parseNum(str) {
  if (!str) return 0;
  let s = str.trim().replace(/["'$‚Ç¨\s]/g, '');
  if (!s) return 0;
  // Formato espa√±ol con miles y decimal: "1.234,56"
  if (s.includes('.') && s.includes(',') && s.lastIndexOf(',') > s.lastIndexOf('.')) {
    s = s.replace(/\./g, '').replace(',', '.');
  }
  // Formato ingl√©s con miles y decimal: "1,234.56"
  else if (s.includes('.') && s.includes(',') && s.lastIndexOf('.') > s.lastIndexOf(',')) {
    s = s.replace(/,/g, '');
  }
  // Solo coma ‚Üí es decimal espa√±ol: "140,21" o "-2,50"
  else if (s.includes(',')) {
    s = s.replace(',', '.');
  }
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function percentRank(arr, val) {
  const sorted = [...arr].sort((a, b) => a - b);
  let below = 0, equal = 0;
  for (const v of sorted) {
    if (v < val) below++;
    else if (Math.abs(v - val) < 0.0001) equal++;
  }
  return ((below + equal * 0.5) / sorted.length) * 100;
}

function getSignalClass(p) { return p >= 75 ? 'fuerte' : p >= 50 ? 'positivo' : p >= 25 ? 'neutral' : 'debil'; }
function getSignalText(p) { return p >= 75 ? 'FUERTE' : p >= 50 ? 'POSITIVO' : p >= 25 ? 'NEUTRAL' : 'D√âBIL'; }
function getBarColor(p) { return p >= 75 ? 'var(--green-strong)' : p >= 50 ? 'var(--blue)' : p >= 25 ? 'var(--yellow)' : 'var(--red)'; }

async function fetchData() {
  try {
    const resp = await fetch(CSV_URL);
    if (!resp.ok) throw new Error('Network error: ' + resp.status);
    const text = await resp.text();
    const rows = parseCSV(text);

    console.log('Raw CSV filas:', rows.length);
    console.log('Fila 0:', rows[0]);
    console.log('Fila 1:', rows[1]);
    console.log('Fila 2:', rows[2]);
    console.log('Fila 3:', rows[3]);

    // Buscar header row
    let headerIdx = -1;
    for (let i = 0; i < Math.min(rows.length, 10); i++) {
      if (rows[i].some(c => c.trim() === 'Ticker')) { headerIdx = i; break; }
    }
    if (headerIdx === -1) throw new Error('Header "Ticker" no encontrado');

    const headers = rows[headerIdx].map(h => h.trim().toLowerCase());
    console.log('Headers:', headers);

    // Mapear columnas por nombre
    const findCol = (name) => headers.findIndex(h => h === name);
    const findColIncludes = (name) => headers.findIndex(h => h.includes(name));

    const col = {
      ticker: findCol('ticker'),
      cat: headers.findIndex(h => h === 'categor√≠a' || h === 'categoria'),
      subcat: headers.findIndex(h => h.includes('sub-categ')),
      roc1m: headers.findIndex(h => h.includes('roc 1m')),
      roc3m: headers.findIndex(h => h.includes('roc 3m')),
      roc6m: headers.findIndex(h => h.includes('roc 6m')),
      roc12m: headers.findIndex(h => h.includes('roc 12m')),
      precio: headers.findIndex(h => h.includes('precio actual')),
    };
    console.log('Column map:', col);

    // Parsear ETFs
    const rawETFs = [];
    for (let i = headerIdx + 1; i < rows.length; i++) {
      const r = rows[i];
      if (!r || r.length < 5) continue;
      const ticker = (r[col.ticker] || '').trim();
      if (!ticker || ticker.length > 6) continue;

      const etf = {
        ticker,
        cat: (r[col.cat] || '').trim(),
        subcat: (r[col.subcat] || '').trim(),
        roc1m: parseNum(r[col.roc1m]),
        roc3m: parseNum(r[col.roc3m]),
        roc6m: parseNum(r[col.roc6m]),
        roc12m: parseNum(r[col.roc12m]),
        precio: parseNum(r[col.precio]),
      };

      console.log(`${etf.ticker}: ROC1M raw="${r[col.roc1m]}" ‚Üí ${etf.roc1m} | ROC3M raw="${r[col.roc3m]}" ‚Üí ${etf.roc3m}`);
      rawETFs.push(etf);
    }

    console.log(`Parseados: ${rawETFs.length} ETFs`);

    const spy = rawETFs.find(e => e.ticker === 'SPY');
    if (!spy) throw new Error('SPY no encontrado');
    console.log('SPY:', spy);

    // Calcular RS
    const etfs = rawETFs.filter(e => e.ticker !== 'SPY').map(e => ({
      ...e,
      rs1m: e.roc1m - spy.roc1m,
      rs3m: e.roc3m - spy.roc3m,
      rs6m: e.roc6m - spy.roc6m,
      rs12m: e.roc12m - spy.roc12m,
    }));

    etfs.forEach(e => { e.rsScore = e.rs1m * 0.35 + e.rs3m * 0.30 + e.rs6m * 0.20 + e.rs12m * 0.15; });

    const allScores = etfs.map(e => e.rsScore);
    etfs.forEach(e => { e.pctlScore = percentRank(allScores, e.rsScore); });

    etfs.sort((a, b) => b.rsScore - a.rsScore);
    etfs.forEach((e, i) => e.rank = i + 1);

    allData = etfs;
    renderAll();

    document.getElementById('benchmark-text').textContent =
      `BENCHMARK: SPY ($${spy.precio.toFixed(2)}) | ${etfs.length} ETFs | LIVE`;
    document.getElementById('last-update').textContent =
      `√öltima actualizaci√≥n: ${new Date().toLocaleString('es-ES')} ‚Äî Auto-refresh cada 5 min`;

  } catch (err) {
    console.error('Error:', err);
    document.getElementById('table-body').innerHTML =
      `<tr><td colspan="11" class="error-msg">
        <p>‚ö†Ô∏è No se pudieron cargar los datos</p>
        <p style="font-size:0.8rem;margin-top:8px;color:var(--text-muted)">${err.message}</p>
      </td></tr>`;
  }
}

function renderAll() { renderStats(); renderFilters(); renderTable(); }

function renderStats() {
  const strong = allData.filter(d => d.pctlScore >= 75).length;
  const positive = allData.filter(d => d.pctlScore >= 50 && d.pctlScore < 75).length;
  const weak = allData.filter(d => d.pctlScore < 25).length;
  const avgRS = allData.length ? (allData.reduce((s, d) => s + d.rsScore, 0) / allData.length).toFixed(1) : '0';
  const top = allData[0]?.ticker || '‚Äî';
  document.getElementById('stats-bar').innerHTML = `
    <div class="stat-card"><div class="stat-value" style="color:var(--green-strong)">${strong}</div><div class="stat-label">üü¢ Fuerte</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--blue)">${positive}</div><div class="stat-label">üîµ Positivo</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--red)">${weak}</div><div class="stat-label">üî¥ D√©bil</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--text-primary)">${avgRS}</div><div class="stat-label">RS Medio</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--accent)">${top}</div><div class="stat-label">üèÜ #1 RS</div></div>
  `;
}

function renderFilters() {
  const cats = ['Todos', ...new Set(allData.map(d => d.cat).filter(Boolean))];
  document.getElementById('filters').innerHTML = cats.map(c =>
    `<button class="filter-btn ${c === activeFilter ? 'active' : ''}" onclick="setFilter('${c}')">${c}</button>`
  ).join('');
}
function setFilter(cat) { activeFilter = cat; renderFilters(); renderTable(); }

function sortData(data) {
  const s = [...data];
  switch (currentSort) {
    case 'rank': s.sort((a,b) => b.rsScore - a.rsScore); break;
    case 'rs1m': s.sort((a,b) => b.rs1m - a.rs1m); break;
    case 'rs3m': s.sort((a,b) => b.rs3m - a.rs3m); break;
    case 'rs12m': s.sort((a,b) => b.rs12m - a.rs12m); break;
    case 'pctl': s.sort((a,b) => b.pctlScore - a.pctlScore); break;
    case 'ticker': s.sort((a,b) => a.ticker.localeCompare(b.ticker)); break;
  }
  return s;
}

function renderTable() {
  let filtered = activeFilter === 'Todos' ? allData : allData.filter(d => d.cat === activeFilter);
  filtered = sortData(filtered);
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = filtered.map((d, i) => {
    const sig = getSignalClass(d.pctlScore);
    const sigText = getSignalText(d.pctlScore);
    const barWidth = Math.max(2, Math.min(100, d.pctlScore));
    const barColor = getBarColor(d.pctlScore);
    const delay = Math.min(i * 25, 600);
    const rsCell = (val) => {
      const cls = val > 0.01 ? 'rs-positive' : val < -0.01 ? 'rs-negative' : 'rs-neutral';
      return `<span class="rs-value ${cls}">${val > 0 ? '+' : ''}${val.toFixed(2)}</span>`;
    };
    return `<tr class="fade-row" style="animation-delay:${delay}ms">
      <td class="rank-cell ${d.rank <= 3 ? 'rank-top3' : ''}">${d.rank}</td>
      <td class="rs-bar-cell"><div class="rs-bar-container"><div class="rs-bar" style="width:${barWidth}%;background:${barColor}"></div></div></td>
      <td class="ticker-cell">${d.ticker}</td>
      <td class="category-cell">${d.subcat || d.cat}</td>
      <td>${rsCell(d.rs1m)}</td>
      <td>${rsCell(d.rs3m)}</td>
      <td>${rsCell(d.rs6m)}</td>
      <td>${rsCell(d.rs12m)}</td>
      <td style="font-weight:700">${rsCell(d.rsScore)}</td>
      <td><span class="pctl-badge pctl-${sig}">${d.pctlScore.toFixed(1)}</span></td>
      <td><span class="signal-badge signal-${sig}"><span class="signal-dot dot-${sig}"></span>${sigText}</span></td>
    </tr>`;
  }).join('');
}

document.getElementById('sort-select').addEventListener('change', (e) => { currentSort = e.target.value; renderTable(); });

fetchData();
setInterval(fetchData, 5 * 60 * 1000);
</script>
</body>
</html>
