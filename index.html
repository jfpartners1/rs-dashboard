<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RS Dashboard ‚Äî Relative Strength vs SPY</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0a0f;
    --bg-card: #12121a;
    --bg-card-alt: #16161f;
    --bg-hover: #1e1e2a;
    --border: #2a2a3a;
    --text-primary: #e8e8f0;
    --text-secondary: #8888a0;
    --text-muted: #55556a;
    --green-strong: #00e676;
    --green-mid: #4caf50;
    --blue: #448aff;
    --yellow: #ffd740;
    --red: #ff5252;
    --accent: #00e676;
    --noise-opacity: 0.03;
    --glow-green: rgba(0,230,118,0.04);
    --glow-blue: rgba(68,138,255,0.03);
    --quad-green: rgba(0,230,118,0.04);
    --quad-yellow: rgba(255,215,64,0.04);
    --quad-red: rgba(255,82,82,0.04);
    --quad-blue: rgba(68,138,255,0.04);
    --grid-line: rgba(255,255,255,0.06);
    --cross-line: rgba(255,255,255,0.2);
    --quad-label-opacity: 0.3;
    --point-label: #e8e8f0;
    --shadow-color: rgba(0,0,0,0.4);
    --corr-neutral-bg: rgba(255,255,255,0.03);
  }
  [data-theme="light"] {
    --bg-primary: #f0f2f5;
    --bg-card: #ffffff;
    --bg-card-alt: #f8f9fa;
    --bg-hover: #e8ecf0;
    --border: #d0d5dd;
    --text-primary: #1a1a2e;
    --text-secondary: #5a5a7a;
    --text-muted: #8a8aa0;
    --green-strong: #0a8f4f;
    --green-mid: #2e7d32;
    --blue: #1565c0;
    --yellow: #f9a825;
    --red: #c62828;
    --accent: #0a8f4f;
    --noise-opacity: 0;
    --glow-green: transparent;
    --glow-blue: transparent;
    --quad-green: rgba(0,180,80,0.06);
    --quad-yellow: rgba(255,200,0,0.06);
    --quad-red: rgba(220,50,50,0.06);
    --quad-blue: rgba(50,120,220,0.06);
    --grid-line: rgba(0,0,0,0.06);
    --cross-line: rgba(0,0,0,0.2);
    --quad-label-opacity: 0.5;
    --point-label: #1a1a2e;
    --shadow-color: rgba(0,0,0,0.08);
    --corr-neutral-bg: rgba(0,0,0,0.03);
  }

  /* Theme toggle */
  .theme-toggle {
    position: fixed; top: 20px; right: 20px; z-index: 50;
    width: 52px; height: 28px; border-radius: 100px; border: none; cursor: pointer;
    background: var(--bg-card); border: 1px solid var(--border);
    display: flex; align-items: center; padding: 3px;
    transition: all 0.3s ease;
  }
  .theme-toggle:hover { border-color: var(--accent); }
  .theme-toggle-knob {
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--accent); display: flex; align-items: center; justify-content: center;
    font-size: 12px; transition: transform 0.3s ease;
  }
  [data-theme="light"] .theme-toggle-knob { transform: translateX(24px); }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg-primary); color: var(--text-primary); font-family: 'Outfit', sans-serif; min-height: 100vh; overflow-x: hidden; }
  .noise-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; opacity: var(--noise-opacity); }
  .glow-orb { position: fixed; border-radius: 50%; filter: blur(120px); pointer-events: none; z-index: 0; }
  .glow-orb-1 { top: -10%; right: -5%; width: 500px; height: 500px; background: var(--glow-green); }
  .glow-orb-2 { bottom: -10%; left: -5%; width: 400px; height: 400px; background: var(--glow-blue); }
  .container { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 24px 20px; }

  .tab-bar { display: flex; gap: 4px; margin-bottom: 24px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 4px; width: fit-content; }
  .tab-btn { padding: 10px 24px; border: none; border-radius: 10px; background: transparent; color: var(--text-secondary); font-family: 'Outfit', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.25s ease; }
  .tab-btn:hover { color: var(--text-primary); }
  .tab-btn.active { background: var(--accent); color: var(--bg-primary); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .header { text-align: center; margin-bottom: 32px; padding: 40px 24px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; position: relative; overflow: hidden; }
  .header::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,transparent,var(--accent),transparent); }
  .header h1 { font-weight: 900; font-size: 2.4rem; letter-spacing: -1px; background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .header .subtitle { font-size: 0.95rem; color: var(--text-secondary); margin-top: 8px; font-weight: 300; }
  .header .benchmark-info { display: inline-flex; align-items: center; gap: 12px; margin-top: 16px; padding: 8px 20px; background: rgba(0,230,118,0.06); border: 1px solid rgba(0,230,118,0.15); border-radius: 100px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent); }
  .pulse-dot { width:8px; height:8px; background:var(--accent); border-radius:50%; animation:pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,230,118,0.4)} 50%{opacity:0.7;box-shadow:0 0 0 8px rgba(0,230,118,0)} }

  .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 28px; }
  .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 18px 20px; text-align: center; transition: all 0.3s ease; }
  .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .stat-card .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1.6rem; font-weight: 700; }
  .stat-card .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 4px; }

  .filters { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
  .filter-btn { padding: 8px 18px; border: 1px solid var(--border); border-radius: 100px; background: transparent; color: var(--text-secondary); font-family: 'Outfit', sans-serif; font-size: 0.85rem; cursor: pointer; transition: all 0.25s ease; }
  .filter-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
  .filter-btn.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); font-weight: 600; }

  .sort-row { display:flex; align-items:center; gap:8px; margin-bottom:14px; font-size:0.8rem; color:var(--text-muted); }
  .sort-row select { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 6px 12px; font-family: 'Outfit', sans-serif; font-size: 0.8rem; cursor: pointer; }

  .table-wrapper { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
  thead th { background: var(--bg-card-alt); color: var(--text-muted); font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.2px; padding: 14px 12px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--border); white-space: nowrap; }
  tbody tr { border-bottom: 1px solid rgba(42,42,58,0.5); transition: background 0.2s ease; }
  tbody tr:hover { background: var(--bg-hover); }
  tbody td { padding: 12px; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 0.82rem; white-space: nowrap; }
  .rank-cell { font-weight: 700; font-size: 0.9rem; width: 50px; }
  .rank-top3 { color: var(--accent); }
  .ticker-cell { font-weight: 700; color: var(--text-primary); font-size: 0.9rem; text-align: left; padding-left: 16px; cursor: pointer; transition: color 0.2s; }
  .ticker-cell:hover { color: var(--accent); text-decoration: underline; }
  .category-cell { font-family: 'Outfit', sans-serif; font-size: 0.78rem; color: var(--text-secondary); text-align: left; }
  .rs-bar-cell { width: 130px; padding: 12px 8px; }
  .rs-bar-container { width:100%; height:22px; background:rgba(255,255,255,0.04); border-radius:4px; overflow:hidden; }
  .rs-bar { height:100%; border-radius:4px; transition:width 0.8s cubic-bezier(0.22,1,0.36,1); position:relative; }
  .rs-bar::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(180deg,rgba(255,255,255,0.15) 0%,transparent 100%); border-radius:4px; }
  .rs-value { font-weight: 600; }
  .rs-positive { color: var(--green-strong); }
  .rs-negative { color: var(--red); }
  .rs-neutral { color: var(--yellow); }
  .pctl-badge { display:inline-block; padding:3px 10px; border-radius:6px; font-weight:600; font-size:0.78rem; min-width:48px; }
  .pctl-strong { background:rgba(0,230,118,0.15); color:var(--green-strong); }
  .pctl-positive { background:rgba(68,138,255,0.15); color:var(--blue); }
  .pctl-neutral { background:rgba(255,215,64,0.12); color:var(--yellow); }
  .pctl-weak { background:rgba(255,82,82,0.12); color:var(--red); }
  .signal-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:100px; font-family:'Outfit',sans-serif; font-size:0.78rem; font-weight:600; }
  .signal-fuerte { background:rgba(0,230,118,0.1); color:var(--green-strong); border:1px solid rgba(0,230,118,0.2); }
  .signal-positivo { background:rgba(68,138,255,0.1); color:var(--blue); border:1px solid rgba(68,138,255,0.2); }
  .signal-neutral { background:rgba(255,215,64,0.08); color:var(--yellow); border:1px solid rgba(255,215,64,0.15); }
  .signal-debil { background:rgba(255,82,82,0.08); color:var(--red); border:1px solid rgba(255,82,82,0.15); }
  .signal-dot { width:6px; height:6px; border-radius:50%; }
  .dot-fuerte { background:var(--green-strong); box-shadow:0 0 6px var(--green-strong); }
  .dot-positivo { background:var(--blue); box-shadow:0 0 6px var(--blue); }
  .dot-neutral { background:var(--yellow); box-shadow:0 0 6px var(--yellow); }
  .dot-debil { background:var(--red); box-shadow:0 0 6px var(--red); }
  .loading { text-align:center; padding:80px 20px; }
  .loading-spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto 16px; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { color:var(--text-muted); font-size:0.9rem; }
  .error-msg { text-align:center; padding:60px 20px; color:var(--red); }
  .last-update { text-align:center; margin-top:20px; font-size:0.75rem; color:var(--text-muted); font-family:'JetBrains Mono',monospace; }
  .fade-row { opacity:0; animation:fadeIn 0.4s ease forwards; }
  @keyframes fadeIn { to{opacity:1} }

  /* HEATMAP */
  .hm-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 32px; }
  .hm-title { font-weight: 700; font-size: 1.3rem; margin-bottom: 4px; }
  .hm-subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 20px; }
  .hm-controls { display: flex; align-items: center; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
  .hm-control-label { font-size: 0.8rem; color: var(--text-muted); }
  .hm-select {
    background: var(--bg-card-alt); color: var(--text-primary); border: 1px solid var(--border);
    border-radius: 8px; padding: 8px 14px; font-family: 'Outfit', sans-serif; font-size: 0.85rem; cursor: pointer;
  }
  .hm-canvas { min-height: 400px; }
  .hm-group-section { margin-bottom: 20px; }
  .hm-group-label {
    font-weight: 700; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;
    padding-bottom: 6px; border-bottom: 1px solid var(--border);
    text-transform: uppercase; letter-spacing: 1px;
  }
  .hm-grid { display: flex; flex-wrap: wrap; gap: 4px; }
  .hm-cell {
    border-radius: 8px; display: flex; flex-direction: column; align-items: center;
    justify-content: center; padding: 8px 4px; cursor: pointer;
    transition: all 0.2s ease; position: relative; overflow: hidden;
    min-width: 70px; min-height: 65px;
  }
  .hm-cell:hover { transform: scale(1.08); z-index: 5; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
  .hm-cell-ticker {
    font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 0.8rem;
    color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
  }
  .hm-cell-val {
    font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 0.72rem;
    color: rgba(255,255,255,0.85); text-shadow: 0 1px 3px rgba(0,0,0,0.5); margin-top: 2px;
  }
  .hm-cell-name {
    font-family: 'Outfit', sans-serif; font-size: 0.58rem;
    color: rgba(255,255,255,0.6); margin-top: 1px;
    max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .hm-scale { display: flex; align-items: center; justify-content: center; gap: 12px; margin-top: 20px; }
  .hm-scale-bar { width: 250px; height: 14px; border-radius: 7px; background: linear-gradient(90deg, #b71c1c, #ef5350, #555, #43a047, #1b5e20); }
  .hm-scale-neg { font-size: 0.7rem; color: var(--red); font-family: 'JetBrains Mono', monospace; }
  .hm-scale-pos { font-size: 0.7rem; color: var(--green-strong); font-family: 'JetBrains Mono', monospace; }

  /* TradingView Modal */
  .tv-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
    z-index: 200; align-items: center; justify-content: center;
  }
  .tv-overlay.active { display: flex; }
  .tv-modal {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px;
    width: 92%; max-width: 1000px; height: 75vh; max-height: 650px;
    overflow: hidden; position: relative;
    box-shadow: 0 24px 80px rgba(0,0,0,0.5);
    animation: modalIn 0.3s ease;
  }
  @keyframes modalIn { from { opacity:0; transform:scale(0.95) translateY(20px); } to { opacity:1; transform:scale(1) translateY(0); } }
  .tv-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 24px; border-bottom: 1px solid var(--border);
  }
  .tv-header-left { display: flex; align-items: center; gap: 12px; }
  .tv-ticker-label { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.3rem; color: var(--accent); }
  .tv-cat-label { font-size: 0.82rem; color: var(--text-secondary); }
  .tv-rs-info { display: flex; gap: 16px; font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; }
  .tv-close {
    width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border);
    background: transparent; color: var(--text-secondary); font-size: 1.2rem;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .tv-close:hover { background: var(--red); color: #fff; border-color: var(--red); }
  .tv-chart-container { width: 100%; height: calc(100% - 70px); }

  /* RRG */
  .rrg-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 32px; margin-bottom: 24px; position: relative; }
  .rrg-title { font-weight: 700; font-size: 1.3rem; margin-bottom: 4px; }
  .rrg-subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 24px; }
  .rrg-chart-area { position: relative; width: 100%; aspect-ratio: 1.4 / 1; max-height: 600px; }
  .rrg-canvas { width: 100%; height: 100%; }
  .rrg-legend { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 24px; }
  .rrg-legend-item { display: flex; align-items: center; gap: 10px; padding: 10px 16px; background: var(--bg-card-alt); border-radius: 10px; border: 1px solid var(--border); }
  .rrg-legend-color { width: 14px; height: 14px; border-radius: 4px; flex-shrink: 0; }
  .rrg-legend-label { font-size: 0.82rem; font-weight: 600; }
  .rrg-legend-desc { font-size: 0.72rem; color: var(--text-muted); }
  .rrg-filters { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
  .rrg-tooltip { position: absolute; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; pointer-events: none; z-index: 10; font-size: 0.8rem; display: none; backdrop-filter: blur(8px); box-shadow: 0 8px 32px var(--shadow-color); }
  .rrg-tooltip .tt-ticker { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; }
  .rrg-tooltip .tt-cat { color: var(--text-muted); font-size: 0.72rem; margin-bottom: 6px; }
  .rrg-tooltip .tt-row { display: flex; justify-content: space-between; gap: 16px; }
  .rrg-tooltip .tt-label { color: var(--text-muted); }
  .rrg-tooltip .tt-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; }

  /* CORRELATION MATRIX */
  .corr-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 32px; }
  .corr-title { font-weight: 700; font-size: 1.3rem; margin-bottom: 4px; }
  .corr-subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; }
  .corr-note { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 24px; font-style: italic; }
  .corr-scroll { overflow-x: auto; margin-bottom: 20px; }
  .corr-table { border-collapse: collapse; }
  .corr-table th, .corr-table td {
    padding: 0; width: 52px; height: 52px; min-width: 52px;
    text-align: center; vertical-align: middle;
    font-family: 'JetBrains Mono', monospace; font-size: 0.68rem;
    border: 1px solid rgba(42,42,58,0.3);
    position: relative;
  }
  .corr-table th {
    background: var(--bg-card-alt); color: var(--text-secondary);
    font-weight: 700; font-size: 0.65rem; letter-spacing: 0.5px;
    position: sticky; z-index: 2;
  }
  .corr-table th.corr-row-header { left: 0; z-index: 3; text-align: right; padding-right: 8px; width: 60px; min-width: 60px; }
  .corr-table thead th { top: 0; }
  .corr-table td { font-weight: 600; cursor: default; transition: transform 0.15s ease; }
  .corr-table td:hover { transform: scale(1.15); z-index: 5; box-shadow: 0 0 12px rgba(0,0,0,0.5); }
  .corr-table td .corr-val { position: relative; z-index: 1; }

  .corr-scale { display: flex; align-items: center; gap: 8px; margin-top: 16px; justify-content: center; }
  .corr-scale-bar { width: 300px; height: 16px; border-radius: 8px; background: linear-gradient(90deg, #ff5252, #ff525240, #1a1a2e, #00e67640, #00e676); }
  .corr-scale-labels { display: flex; justify-content: space-between; width: 300px; font-size: 0.7rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

  .corr-filter-row { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .corr-filter-label { font-size: 0.8rem; color: var(--text-muted); margin-right: 4px; }

  /* Tooltip for correlation */
  .corr-tooltip {
    position: fixed; background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 16px; pointer-events: none; z-index: 100;
    font-size: 0.82rem; display: none; backdrop-filter: blur(8px);
    box-shadow: 0 8px 32px var(--shadow-color);
  }

  @media (max-width: 900px) {
    .header h1 { font-size: 1.6rem; }
    .table-wrapper { overflow-x: auto; }
    table { min-width: 900px; }
    .container { padding: 12px 10px; }
    .rrg-chart-area { aspect-ratio: 1/1; }
    .tab-bar { width: 100%; }
    .tab-btn { flex: 1; text-align: center; padding: 10px 8px; font-size: 0.78rem; }
    .corr-table th, .corr-table td { width: 42px; height: 42px; min-width: 42px; font-size: 0.6rem; }
  }
</style>
</head>
<body>

<div class="noise-overlay"></div>
<div class="glow-orb glow-orb-1"></div>
<div class="glow-orb glow-orb-2"></div>

<button class="theme-toggle" id="theme-toggle" title="Cambiar tema">
  <div class="theme-toggle-knob" id="toggle-knob">üåô</div>
</button>

<div class="container">
  <div class="header">
    <h1>‚ö° RS Dashboard</h1>
    <div class="subtitle">Relative Strength vs SPY ‚Äî Datos en vivo desde Google Sheets + GOOGLEFINANCE</div>
    <div class="benchmark-info">
      <div class="pulse-dot"></div>
      <span id="benchmark-text">Cargando datos...</span>
    </div>
  </div>

  <div class="tab-bar">
    <button class="tab-btn active" data-tab="table">üìä RS Table</button>
    <button class="tab-btn" data-tab="rrg">üîÑ RRG</button>
    <button class="tab-btn" data-tab="corr">üîó Correlaci√≥n</button>
    <button class="tab-btn" data-tab="heatmap">üü© Heatmap</button>
  </div>

  <!-- TAB 1: RS TABLE -->
  <div id="tab-table" class="tab-content active">
    <div class="stats-bar" id="stats-bar"></div>
    <div class="filters" id="filters"></div>
    <div class="sort-row">
      <span>Ordenar por:</span>
      <select id="sort-select">
        <option value="rank">Rank (RS Score)</option>
        <option value="rs1m">RS 1M</option>
        <option value="rs3m">RS 3M</option>
        <option value="rs12m">RS 12M</option>
        <option value="pctl">Percentil</option>
        <option value="ticker">Ticker A-Z</option>
      </select>
    </div>
    <div class="table-wrapper">
      <table><thead><tr>
        <th>#</th><th>RS</th><th>Ticker</th><th>Categor√≠a</th>
        <th>RS 1M</th><th>RS 3M</th><th>RS 6M</th><th>RS 12M</th>
        <th>RS Score</th><th>Pctl</th><th>Se√±al</th>
      </tr></thead><tbody id="table-body">
        <tr><td colspan="11" class="loading"><div class="loading-spinner"></div><div class="loading-text">Cargando datos desde Google Sheets...</div></td></tr>
      </tbody></table>
    </div>
  </div>

  <!-- TAB 2: RRG -->
  <div id="tab-rrg" class="tab-content">
    <div class="rrg-container">
      <div class="rrg-title">üîÑ Relative Rotation Graph (RRG)</div>
      <div class="rrg-subtitle">Eje X: RS-Ratio (fuerza relativa) ‚Äî Eje Y: RS-Momentum (aceleraci√≥n) ‚Äî Rotaci√≥n en sentido horario</div>
      <div class="rrg-filters" id="rrg-filters"></div>
      <div class="rrg-chart-area">
        <canvas id="rrg-canvas" class="rrg-canvas"></canvas>
        <div class="rrg-tooltip" id="rrg-tooltip">
          <div class="tt-ticker"></div>
          <div class="tt-cat"></div>
          <div class="tt-row"><span class="tt-label">RS-Ratio</span><span class="tt-val" id="tt-ratio"></span></div>
          <div class="tt-row"><span class="tt-label">RS-Momentum</span><span class="tt-val" id="tt-mom"></span></div>
          <div class="tt-row"><span class="tt-label">Cuadrante</span><span class="tt-val" id="tt-quad"></span></div>
        </div>
      </div>
      <div class="rrg-legend">
        <div class="rrg-legend-item"><div class="rrg-legend-color" style="background:#00e676"></div><div><div class="rrg-legend-label">üü¢ L√≠deres</div><div class="rrg-legend-desc">RS fuerte y mejorando</div></div></div>
        <div class="rrg-legend-item"><div class="rrg-legend-color" style="background:#ffd740"></div><div><div class="rrg-legend-label">üü° Debilit√°ndose</div><div class="rrg-legend-desc">RS fuerte pero perdiendo impulso</div></div></div>
        <div class="rrg-legend-item"><div class="rrg-legend-color" style="background:#ff5252"></div><div><div class="rrg-legend-label">üî¥ Rezagados</div><div class="rrg-legend-desc">RS d√©bil y empeorando</div></div></div>
        <div class="rrg-legend-item"><div class="rrg-legend-color" style="background:#448aff"></div><div><div class="rrg-legend-label">üîµ Mejorando</div><div class="rrg-legend-desc">RS d√©bil pero ganando impulso</div></div></div>
      </div>
    </div>
  </div>

  <!-- TAB 3: CORRELATION -->
  <div id="tab-corr" class="tab-content">
    <div class="corr-container">
      <div class="corr-title">üîó Matriz de Correlaci√≥n Sectorial</div>
      <div class="corr-subtitle">Basada en perfiles de ROC (1M, 3M, 6M, 12M) ‚Äî Muestra similitud de comportamiento entre ETFs</div>
      <div class="corr-note">‚ö†Ô∏è Aproximaci√≥n basada en 4 puntos de ROC. Para correlaci√≥n precisa se necesitar√≠an retornos diarios hist√≥ricos.</div>
      <div class="corr-filter-row">
        <span class="corr-filter-label">Mostrar:</span>
        <div id="corr-filters"></div>
      </div>
      <div class="corr-scroll" id="corr-scroll"></div>
      <div class="corr-scale">
        <span style="font-size:0.7rem;color:var(--red)">-1.0</span>
        <div class="corr-scale-bar"></div>
        <span style="font-size:0.7rem;color:var(--green-strong)">+1.0</span>
      </div>
      <div style="text-align:center;margin-top:4px;font-size:0.68rem;color:var(--text-muted)">Correlaci√≥n negativa ‚Üê ‚Üí Correlaci√≥n positiva</div>
    </div>
    <div class="corr-tooltip" id="corr-tooltip"></div>
  </div>

  <!-- TAB 4: HEATMAP -->
  <div id="tab-heatmap" class="tab-content">
    <div class="hm-container">
      <div class="hm-title">üü© Mapa de Calor Sectorial</div>
      <div class="hm-subtitle">Tama√±o proporcional al valor absoluto ‚Äî Color seg√∫n rendimiento positivo/negativo</div>
      <div class="hm-controls">
        <span class="hm-control-label">M√©trica:</span>
        <select id="hm-metric" class="hm-select">
          <option value="roc1m">ROC 1M %</option>
          <option value="roc3m">ROC 3M %</option>
          <option value="roc6m">ROC 6M %</option>
          <option value="roc12m">ROC 12M %</option>
          <option value="rsScore" selected>RS Score</option>
          <option value="rs1m">RS 1M</option>
          <option value="rs3m">RS 3M</option>
          <option value="rs6m">RS 6M</option>
          <option value="rs12m">RS 12M</option>
          <option value="pctlScore">Percentil</option>
        </select>
        <span class="hm-control-label" style="margin-left:16px">Agrupar por:</span>
        <select id="hm-group" class="hm-select">
          <option value="cat">Categor√≠a</option>
          <option value="subcat">Sub-categor√≠a</option>
          <option value="none">Sin agrupar</option>
        </select>
      </div>
      <div class="hm-canvas" id="hm-canvas"></div>
      <div class="hm-scale">
        <span class="hm-scale-neg">‚óÑ Negativo</span>
        <div class="hm-scale-bar"></div>
        <span class="hm-scale-pos">Positivo ‚ñ∫</span>
      </div>
    </div>
  </div>

  <div class="last-update" id="last-update"></div>
</div>

<!-- TradingView Chart Modal -->
<div class="tv-overlay" id="tv-overlay">
  <div class="tv-modal">
    <div class="tv-header">
      <div class="tv-header-left">
        <span class="tv-ticker-label" id="tv-ticker"></span>
        <span class="tv-cat-label" id="tv-cat"></span>
        <div class="tv-rs-info">
          <span id="tv-rs-score"></span>
          <span id="tv-signal"></span>
        </div>
      </div>
      <button class="tv-close" id="tv-close">‚úï</button>
    </div>
    <div class="tv-chart-container" id="tv-chart-container"></div>
  </div>
</div>

<script>
const CSV_URL_RAW = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5uGhOzwIrat1XzG3IW0f_KOHywLJVWLQr6vSkAg2e2cKjX8lXB8iupdXf4zTlSA/pub?gid=1683781233&single=true&output=csv';
const CSV_URL = 'https://corsproxy.io/?' + encodeURIComponent(CSV_URL_RAW);

let allData = [], allDataWithSPY = [];
let activeFilter = 'Todos', currentSort = 'rank', rrgFilter = 'Todos', corrFilter = 'Sector GICS';
let rrgPoints = [];

// ===== TABS =====
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
    if (tab === 'rrg' && allData.length) requestAnimationFrame(drawRRG);
    if (tab === 'corr' && allData.length) requestAnimationFrame(drawCorrelation);
    if (tab === 'heatmap' && allData.length) drawHeatmap();
  });
});

// ===== CSV =====
function parseCSV(text) {
  const rows = [], lines = text.split('\n');
  for (const line of lines) {
    const cols = []; let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') inQ = !inQ;
      else if (ch === ',' && !inQ) { cols.push(cur.trim()); cur = ''; }
      else cur += ch;
    }
    cols.push(cur.trim()); rows.push(cols);
  }
  return rows;
}
function parseNum(str) {
  if (!str) return 0;
  let s = str.trim().replace(/["'$‚Ç¨\s]/g, '');
  if (!s) return 0;
  if (s.includes('.') && s.includes(',') && s.lastIndexOf(',') > s.lastIndexOf('.'))
    s = s.replace(/\./g, '').replace(',', '.');
  else if (s.includes('.') && s.includes(',') && s.lastIndexOf('.') > s.lastIndexOf(','))
    s = s.replace(/,/g, '');
  else if (s.includes(',')) s = s.replace(',', '.');
  const n = parseFloat(s); return isNaN(n) ? 0 : n;
}
function percentRank(arr, val) {
  const sorted = [...arr].sort((a,b) => a-b);
  let below = 0, equal = 0;
  for (const v of sorted) { if (v < val) below++; else if (Math.abs(v-val) < 0.0001) equal++; }
  return ((below + equal*0.5) / sorted.length) * 100;
}
function getSignalClass(p) { return p>=75?'fuerte':p>=50?'positivo':p>=25?'neutral':'debil'; }
function getSignalText(p) { return p>=75?'FUERTE':p>=50?'POSITIVO':p>=25?'NEUTRAL':'D√âBIL'; }
function getBarColor(p) { return p>=75?'var(--green-strong)':p>=50?'var(--blue)':p>=25?'var(--yellow)':'var(--red)'; }

// ===== FETCH CURRENT DATA =====
async function fetchData() {
  try {
    const resp = await fetch(CSV_URL);
    if (!resp.ok) throw new Error('Network error: ' + resp.status);
    const rows = parseCSV(await resp.text());
    let hIdx = -1;
    for (let i = 0; i < Math.min(rows.length, 10); i++) if (rows[i].some(c => c.trim() === 'Ticker')) { hIdx = i; break; }
    if (hIdx === -1) throw new Error('Header no encontrado');
    const hd = rows[hIdx].map(h => h.trim().toLowerCase());
    const col = {
      ticker: hd.indexOf('ticker'),
      cat: hd.findIndex(h => h==='categor√≠a'||h==='categoria'),
      subcat: hd.findIndex(h => h.includes('sub-categ')),
      roc1m: hd.findIndex(h => h.includes('roc 1m')),
      roc3m: hd.findIndex(h => h.includes('roc 3m')),
      roc6m: hd.findIndex(h => h.includes('roc 6m')),
      roc12m: hd.findIndex(h => h.includes('roc 12m')),
      precio: hd.findIndex(h => h.includes('precio actual')),
    };
    const rawETFs = [];
    for (let i = hIdx+1; i < rows.length; i++) {
      const r = rows[i]; if (!r || r.length < 5) continue;
      const ticker = (r[col.ticker]||'').trim(); if (!ticker || ticker.length > 6) continue;
      rawETFs.push({ ticker, cat:(r[col.cat]||'').trim(), subcat:(r[col.subcat]||'').trim(),
        roc1m:parseNum(r[col.roc1m]), roc3m:parseNum(r[col.roc3m]),
        roc6m:parseNum(r[col.roc6m]), roc12m:parseNum(r[col.roc12m]), precio:parseNum(r[col.precio]) });
    }
    allDataWithSPY = rawETFs;
    const spy = rawETFs.find(e => e.ticker === 'SPY');
    if (!spy) throw new Error('SPY no encontrado');
    const etfs = rawETFs.filter(e => e.ticker !== 'SPY').map(e => ({
      ...e, rs1m:e.roc1m-spy.roc1m, rs3m:e.roc3m-spy.roc3m, rs6m:e.roc6m-spy.roc6m, rs12m:e.roc12m-spy.roc12m,
    }));
    etfs.forEach(e => { e.rsScore = e.rs1m*0.35 + e.rs3m*0.30 + e.rs6m*0.20 + e.rs12m*0.15; });
    const allR = etfs.map(e => (e.rs3m+e.rs6m+e.rs12m)/3);
    const allM = etfs.map(e => e.rs1m - (e.rs6m+e.rs12m)/2);
    const rMu = allR.reduce((a,b)=>a+b,0)/allR.length, mMu = allM.reduce((a,b)=>a+b,0)/allM.length;
    const rS = Math.sqrt(allR.reduce((s,v)=>s+(v-rMu)**2,0)/allR.length)||1;
    const mS = Math.sqrt(allM.reduce((s,v)=>s+(v-mMu)**2,0)/allM.length)||1;
    etfs.forEach((e,i) => {
      e.rsRatio = ((allR[i]-rMu)/rS)*100+100;
      e.rsMomentum = ((allM[i]-mMu)/mS)*100+100;
      if (e.rsRatio>=100 && e.rsMomentum>=100) e.quadrant='leading';
      else if (e.rsRatio>=100) e.quadrant='weakening';
      else if (e.rsMomentum<100) e.quadrant='lagging';
      else e.quadrant='improving';
    });
    const allScores = etfs.map(e => e.rsScore);
    etfs.forEach(e => { e.pctlScore = percentRank(allScores, e.rsScore); });
    etfs.sort((a,b) => b.rsScore - a.rsScore);
    etfs.forEach((e,i) => { e.rank = i+1; });
    allData = etfs;
    renderAll();
    document.getElementById('benchmark-text').textContent = `BENCHMARK: SPY ($${spy.precio.toFixed(2)}) | ${etfs.length} ETFs | LIVE`;
    document.getElementById('last-update').textContent = `√öltima actualizaci√≥n: ${new Date().toLocaleString('es-ES')} ‚Äî Auto-refresh cada 5 min`;
  } catch(err) {
    console.error(err);
    document.getElementById('table-body').innerHTML = `<tr><td colspan="11" class="error-msg"><p>‚ö†Ô∏è ${err.message}</p></td></tr>`;
  }
}

// ===== TABLE =====
function renderAll() { renderStats(); renderFilters(); renderTable(); renderRRGFilters(); renderCorrFilters(); }
function renderStats() {
  const s=allData.filter(d=>d.pctlScore>=75).length, p=allData.filter(d=>d.pctlScore>=50&&d.pctlScore<75).length;
  const w=allData.filter(d=>d.pctlScore<25).length;
  const avg=allData.length?(allData.reduce((a,d)=>a+d.rsScore,0)/allData.length).toFixed(1):'0';
  document.getElementById('stats-bar').innerHTML = `
    <div class="stat-card"><div class="stat-value" style="color:var(--green-strong)">${s}</div><div class="stat-label">üü¢ Fuerte</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--blue)">${p}</div><div class="stat-label">üîµ Positivo</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--red)">${w}</div><div class="stat-label">üî¥ D√©bil</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--text-primary)">${avg}</div><div class="stat-label">RS Medio</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--accent)">${allData[0]?.ticker||'‚Äî'}</div><div class="stat-label">üèÜ #1 RS</div></div>`;
}
function renderFilters() {
  const cats = ['Todos', ...new Set(allData.map(d=>d.cat).filter(Boolean))];
  document.getElementById('filters').innerHTML = cats.map(c=>`<button class="filter-btn ${c===activeFilter?'active':''}" onclick="setFilter('${c}')">${c}</button>`).join('');
}
function setFilter(c) { activeFilter=c; renderFilters(); renderTable(); }
function sortData(d) {
  const s=[...d];
  switch(currentSort) {
    case 'rank':s.sort((a,b)=>b.rsScore-a.rsScore);break;case 'rs1m':s.sort((a,b)=>b.rs1m-a.rs1m);break;
    case 'rs3m':s.sort((a,b)=>b.rs3m-a.rs3m);break;case 'rs12m':s.sort((a,b)=>b.rs12m-a.rs12m);break;
    case 'pctl':s.sort((a,b)=>b.pctlScore-a.pctlScore);break;case 'ticker':s.sort((a,b)=>a.ticker.localeCompare(b.ticker));break;
  } return s;
}
function renderTable() {
  let f = activeFilter==='Todos'?allData:allData.filter(d=>d.cat===activeFilter);
  f = sortData(f);
  const rsC = v => { const c=v>0.01?'rs-positive':v<-0.01?'rs-negative':'rs-neutral'; return `<span class="rs-value ${c}">${v>0?'+':''}${v.toFixed(2)}</span>`; };
  document.getElementById('table-body').innerHTML = f.map((d,i) => {
    const sig=getSignalClass(d.pctlScore), st=getSignalText(d.pctlScore), bw=Math.max(2,Math.min(100,d.pctlScore));
    
    return `<tr class="fade-row" style="animation-delay:${Math.min(i*25,600)}ms">
      <td class="rank-cell ${d.rank<=3?'rank-top3':''}">${d.rank}</td>
      <td class="rs-bar-cell"><div class="rs-bar-container"><div class="rs-bar" style="width:${bw}%;background:${getBarColor(d.pctlScore)}"></div></div></td>
      <td class="ticker-cell" onclick="openChart('${d.ticker}','${(d.subcat||d.cat).replace(/'/g,"\\'")}',${d.rsScore.toFixed(2)},${d.pctlScore.toFixed(1)})">${d.ticker}</td><td class="category-cell">${d.subcat||d.cat}</td>
      <td>${rsC(d.rs1m)}</td><td>${rsC(d.rs3m)}</td><td>${rsC(d.rs6m)}</td><td>${rsC(d.rs12m)}</td>
      <td style="font-weight:700">${rsC(d.rsScore)}</td>
      <td><span class="pctl-badge pctl-${sig}">${d.pctlScore.toFixed(1)}</span></td>
      <td><span class="signal-badge signal-${sig}"><span class="signal-dot dot-${sig}"></span>${st}</span></td></tr>`;
  }).join('');
}
document.getElementById('sort-select').addEventListener('change', e => { currentSort=e.target.value; renderTable(); });

// ===== RRG =====
function renderRRGFilters() {
  const cats = ['Todos', ...new Set(allData.map(d=>d.cat).filter(Boolean))];
  document.getElementById('rrg-filters').innerHTML = cats.map(c=>`<button class="filter-btn ${c===rrgFilter?'active':''}" onclick="setRRGFilter('${c}')">${c}</button>`).join('');
}
function setRRGFilter(c) { rrgFilter=c; renderRRGFilters(); drawRRG(); }
function drawRRG() {
  const canvas=document.getElementById('rrg-canvas'), ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1, rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*dpr; canvas.height=rect.height*dpr;
  canvas.style.width=rect.width+'px'; canvas.style.height=rect.height+'px';
  ctx.scale(dpr,dpr);
  const W=rect.width, H=rect.height, pad={top:30,right:30,bottom:50,left:60}, cw=W-pad.left-pad.right, ch=H-pad.top-pad.bottom;
  ctx.clearRect(0,0,W,H);
  let data = rrgFilter==='Todos'?allData:allData.filter(d=>d.cat===rrgFilter);
  const minR=Math.min(70,Math.min(...data.map(d=>d.rsRatio))-5), maxR=Math.max(130,Math.max(...data.map(d=>d.rsRatio))+5);
  const minM=Math.min(70,Math.min(...data.map(d=>d.rsMomentum))-5), maxM=Math.max(130,Math.max(...data.map(d=>d.rsMomentum))+5);
  const toX=v=>pad.left+((v-minR)/(maxR-minR))*cw, toY=v=>pad.top+ch-((v-minM)/(maxM-minM))*ch;
  const cx=toX(100), cy=toY(100);
  const cs = getComputedStyle(document.documentElement);
  const isLight = document.documentElement.dataset.theme === 'light';
  ctx.fillStyle=cs.getPropertyValue('--quad-green'); ctx.fillRect(cx,pad.top,pad.left+cw-cx,cy-pad.top);
  ctx.fillStyle=cs.getPropertyValue('--quad-yellow'); ctx.fillRect(cx,cy,pad.left+cw-cx,pad.top+ch-cy);
  ctx.fillStyle=cs.getPropertyValue('--quad-red'); ctx.fillRect(pad.left,cy,cx-pad.left,pad.top+ch-cy);
  ctx.fillStyle=cs.getPropertyValue('--quad-blue'); ctx.fillRect(pad.left,pad.top,cx-pad.left,cy-pad.top);
  ctx.strokeStyle=cs.getPropertyValue('--grid-line'); ctx.lineWidth=1;
  for(let v=Math.ceil(minR/10)*10;v<=maxR;v+=10){if(v===100)continue;const x=toX(v);ctx.beginPath();ctx.moveTo(x,pad.top);ctx.lineTo(x,pad.top+ch);ctx.stroke();}
  for(let v=Math.ceil(minM/10)*10;v<=maxM;v+=10){if(v===100)continue;const y=toY(v);ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cw,y);ctx.stroke();}
  ctx.strokeStyle=cs.getPropertyValue('--cross-line'); ctx.lineWidth=1.5; ctx.setLineDash([6,4]);
  ctx.beginPath();ctx.moveTo(cx,pad.top);ctx.lineTo(cx,pad.top+ch);ctx.stroke();
  ctx.beginPath();ctx.moveTo(pad.left,cy);ctx.lineTo(pad.left+cw,cy);ctx.stroke();
  ctx.setLineDash([]);
  const qAlpha = parseFloat(cs.getPropertyValue('--quad-label-opacity'));
  ctx.font='600 13px Outfit'; ctx.globalAlpha=qAlpha;
  const gCol=isLight?'#0a8f4f':'#00e676', yCol=isLight?'#c89000':'#ffd740', rCol=isLight?'#c62828':'#ff5252', bCol=isLight?'#1565c0':'#448aff';
  ctx.fillStyle=gCol; ctx.fillText('L√çDERES ‚Üó',cx+12,pad.top+22);
  ctx.fillStyle=yCol; ctx.fillText('DEBILIT√ÅNDOSE ‚Üò',cx+12,pad.top+ch-10);
  ctx.fillStyle=rCol; ctx.fillText('REZAGADOS ‚Üô',pad.left+8,pad.top+ch-10);
  ctx.fillStyle=bCol; ctx.fillText('MEJORANDO ‚Üñ',pad.left+8,pad.top+22);
  ctx.globalAlpha=1;
  ctx.font='600 11px JetBrains Mono'; ctx.fillStyle=cs.getPropertyValue('--text-muted').trim(); ctx.textAlign='center';
  for(let v=Math.ceil(minR/10)*10;v<=maxR;v+=10) ctx.fillText(v,toX(v),pad.top+ch+20);
  ctx.textAlign='right';
  for(let v=Math.ceil(minM/10)*10;v<=maxM;v+=10) ctx.fillText(v,pad.left-8,toY(v)+4);
  ctx.font='600 12px Outfit'; ctx.textAlign='center'; ctx.fillStyle=cs.getPropertyValue('--text-muted').trim();
  ctx.fillText('RS-Ratio ‚Üí',W/2,H-6);
  ctx.save();ctx.translate(14,H/2);ctx.rotate(-Math.PI/2);ctx.fillText('RS-Momentum ‚Üí',0,0);ctx.restore();
  const qc={leading:gCol,weakening:yCol,lagging:rCol,improving:bCol};
  rrgPoints=[];
  const lblColor = cs.getPropertyValue('--point-label').trim();
  data.forEach(d => {
    const x=toX(d.rsRatio), y=toY(d.rsMomentum), color=qc[d.quadrant];
    const grd=ctx.createRadialGradient(x,y,7,x,y,15); grd.addColorStop(0,color+'30'); grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(x,y,15,0,Math.PI*2); ctx.fill();
    ctx.beginPath();ctx.arc(x,y,7,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,0.15)';ctx.lineWidth=1;ctx.stroke();
    ctx.font='700 10px JetBrains Mono';ctx.fillStyle=lblColor;ctx.textAlign='center';ctx.fillText(d.ticker,x,y-12);
    rrgPoints.push({x,y,r:14,data:d});
  });
}
const rrCanvas=document.getElementById('rrg-canvas'), rrTT=document.getElementById('rrg-tooltip');
rrCanvas.addEventListener('mousemove',e=>{
  const rect=rrCanvas.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top;
  let found=null; for(const p of rrgPoints) if(Math.hypot(mx-p.x,my-p.y)<p.r){found=p;break;}
  if(found){const d=found.data;rrTT.style.display='block';rrTT.style.left=(found.x+18)+'px';rrTT.style.top=(found.y-40)+'px';
    rrTT.querySelector('.tt-ticker').textContent=d.ticker;rrTT.querySelector('.tt-cat').textContent=d.subcat||d.cat;
    document.getElementById('tt-ratio').textContent=d.rsRatio.toFixed(1);document.getElementById('tt-mom').textContent=d.rsMomentum.toFixed(1);
    document.getElementById('tt-quad').textContent={leading:'üü¢ L√≠der',weakening:'üü° Debilit√°ndose',lagging:'üî¥ Rezagado',improving:'üîµ Mejorando'}[d.quadrant];
  } else rrTT.style.display='none';
});
rrCanvas.addEventListener('mouseleave',()=>{rrTT.style.display='none';});
window.addEventListener('resize',()=>{if(allData.length){if(document.getElementById('tab-rrg').classList.contains('active'))drawRRG();if(document.getElementById('tab-corr').classList.contains('active'))drawCorrelation();}});

// ===== CORRELATION MATRIX =====
function pearsonCorr(a, b) {
  const n = a.length;
  if (n === 0) return 0;
  const meanA = a.reduce((s,v)=>s+v,0)/n, meanB = b.reduce((s,v)=>s+v,0)/n;
  let num=0, denA=0, denB=0;
  for (let i=0;i<n;i++) {
    const da=a[i]-meanA, db=b[i]-meanB;
    num+=da*db; denA+=da*da; denB+=db*db;
  }
  const den = Math.sqrt(denA)*Math.sqrt(denB);
  return den===0 ? 0 : num/den;
}

function corrColor(v) {
  const isLight = document.documentElement.dataset.theme === 'light';
  if (v >= 0.8) return { bg: isLight?'rgba(10,143,79,0.6)':'rgba(0,230,118,0.7)', fg:'#fff' };
  if (v >= 0.5) return { bg: isLight?'rgba(10,143,79,0.3)':'rgba(0,230,118,0.4)', fg: isLight?'#1a1a2e':'#e8e8f0' };
  if (v >= 0.2) return { bg: isLight?'rgba(10,143,79,0.1)':'rgba(0,230,118,0.15)', fg: isLight?'#1a1a2e':'#e8e8f0' };
  if (v >= -0.2) return { bg: isLight?'rgba(0,0,0,0.03)':'rgba(255,255,255,0.03)', fg: isLight?'#8a8aa0':'#8888a0' };
  if (v >= -0.5) return { bg: isLight?'rgba(198,40,40,0.1)':'rgba(255,82,82,0.15)', fg: isLight?'#1a1a2e':'#e8e8f0' };
  if (v >= -0.8) return { bg: isLight?'rgba(198,40,40,0.3)':'rgba(255,82,82,0.4)', fg: isLight?'#1a1a2e':'#e8e8f0' };
  return { bg: isLight?'rgba(198,40,40,0.6)':'rgba(255,82,82,0.7)', fg:'#fff' };
}

function renderCorrFilters() {
  const cats = ['Sector GICS', 'Industria', 'Tem√°tico', 'Factor', 'Todos'];
  document.getElementById('corr-filters').innerHTML = cats.map(c =>
    `<button class="filter-btn ${c===corrFilter?'active':''}" onclick="setCorrFilter('${c}')">${c}</button>`
  ).join('');
}
function setCorrFilter(c) { corrFilter=c; renderCorrFilters(); drawCorrelation(); }

function drawCorrelation() {
  // Use allDataWithSPY to include benchmarks too
  let data;
  if (corrFilter === 'Todos') {
    data = allDataWithSPY;
  } else {
    data = allDataWithSPY.filter(d => d.cat === corrFilter);
  }
  if (data.length < 2) {
    document.getElementById('corr-scroll').innerHTML = '<p style="color:var(--text-muted);padding:20px;">No hay suficientes ETFs en esta categor√≠a</p>';
    return;
  }

  // Build ROC vectors for each ETF
  const vectors = data.map(d => [d.roc1m, d.roc3m, d.roc6m, d.roc12m]);
  const n = data.length;

  // Calculate correlation matrix
  const corrMatrix = [];
  for (let i=0;i<n;i++) {
    corrMatrix[i] = [];
    for (let j=0;j<n;j++) {
      corrMatrix[i][j] = i===j ? 1 : pearsonCorr(vectors[i], vectors[j]);
    }
  }

  // Build HTML table
  let html = '<table class="corr-table"><thead><tr><th class="corr-row-header"></th>';
  for (let j=0;j<n;j++) html += `<th>${data[j].ticker}</th>`;
  html += '</tr></thead><tbody>';

  for (let i=0;i<n;i++) {
    html += `<tr><th class="corr-row-header">${data[i].ticker}</th>`;
    for (let j=0;j<n;j++) {
      const v = corrMatrix[i][j];
      const {bg,fg} = corrColor(v);
      const display = i===j ? '‚Äî' : v.toFixed(2);
      const opacity = i===j ? '0.3' : '1';
      html += `<td style="background:${bg};color:${fg};opacity:${opacity}"
                   data-row="${data[i].ticker}" data-col="${data[j].ticker}"
                   data-rowi="${data[i].subcat||data[i].cat}" data-coli="${data[j].subcat||data[j].cat}"
                   data-val="${v.toFixed(3)}"
                   onmouseenter="showCorrTT(event)" onmouseleave="hideCorrTT()">
                <span class="corr-val">${display}</span></td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById('corr-scroll').innerHTML = html;
}

function showCorrTT(e) {
  const td = e.target.closest('td');
  if (!td) return;
  const r = td.dataset.row, c = td.dataset.col, ri = td.dataset.rowi, ci = td.dataset.coli, v = parseFloat(td.dataset.val);
  if (r === c) return;
  const tt = document.getElementById('corr-tooltip');
  let interpretation = '';
  if (v >= 0.8) interpretation = 'üü¢ Muy alta ‚Äî Se mueven casi igual';
  else if (v >= 0.5) interpretation = 'üü¢ Alta ‚Äî Comportamiento similar';
  else if (v >= 0.2) interpretation = 'üîµ Moderada ‚Äî Cierta relaci√≥n';
  else if (v >= -0.2) interpretation = '‚ö™ Baja ‚Äî Poco relacionados (diversificaci√≥n)';
  else if (v >= -0.5) interpretation = 'üü° Negativa moderada ‚Äî Tienden a moverse opuesto';
  else interpretation = 'üî¥ Muy negativa ‚Äî Se mueven en direcci√≥n opuesta';

  tt.innerHTML = `
    <div style="font-weight:700;font-size:0.95rem;margin-bottom:2px">${r} ‚Üî ${c}</div>
    <div style="color:var(--text-muted);font-size:0.72rem;margin-bottom:8px">${ri} vs ${ci}</div>
    <div style="font-family:'JetBrains Mono';font-size:1.1rem;font-weight:700;margin-bottom:6px;color:${v>=0?'var(--green-strong)':'var(--red)'}">${v>=0?'+':''}${v.toFixed(3)}</div>
    <div style="font-size:0.78rem">${interpretation}</div>
  `;
  tt.style.display = 'block';
  tt.style.left = (e.clientX + 16) + 'px';
  tt.style.top = (e.clientY - 20) + 'px';
}
function hideCorrTT() { document.getElementById('corr-tooltip').style.display='none'; }

// ===== TRADINGVIEW CHART =====
function openChart(ticker, category, rsScore, pctl) {
  const overlay = document.getElementById('tv-overlay');
  const container = document.getElementById('tv-chart-container');
  const isLight = document.documentElement.dataset.theme === 'light';
  
  document.getElementById('tv-ticker').textContent = ticker;
  document.getElementById('tv-cat').textContent = category;
  
  const rsColor = rsScore > 0 ? 'var(--green-strong)' : 'var(--red)';
  document.getElementById('tv-rs-score').innerHTML = `RS: <span style="color:${rsColor};font-weight:700">${rsScore > 0 ? '+' : ''}${rsScore}</span>`;
  
  const sigClass = pctl >= 75 ? 'fuerte' : pctl >= 50 ? 'positivo' : pctl >= 25 ? 'neutral' : 'debil';
  const sigText = pctl >= 75 ? 'üü¢ FUERTE' : pctl >= 50 ? 'üîµ POSITIVO' : pctl >= 25 ? 'üü° NEUTRAL' : 'üî¥ D√âBIL';
  document.getElementById('tv-signal').innerHTML = `Pctl: <span style="font-weight:700">${pctl}</span> ${sigText}`;
  
  // Create TradingView widget
  container.innerHTML = '';
  const widgetDiv = document.createElement('div');
  widgetDiv.id = 'tradingview_widget';
  widgetDiv.style.width = '100%';
  widgetDiv.style.height = '100%';
  container.appendChild(widgetDiv);
  
  const script = document.createElement('script');
  script.src = 'https://s3.tradingview.com/tv.js';
  script.onload = function() {
    new TradingView.widget({
      "autosize": true,
      "symbol": ticker,
      "interval": "D",
      "timezone": "Europe/Madrid",
      "theme": isLight ? "light" : "dark",
      "style": "1",
      "locale": "es",
      "toolbar_bg": isLight ? "#ffffff" : "#12121a",
      "enable_publishing": false,
      "hide_top_toolbar": false,
      "hide_legend": false,
      "save_image": false,
      "container_id": "tradingview_widget",
      "studies": ["RSI@tv-basicstudies", "MASimple@tv-basicstudies"],
      "range": "6M"
    });
  };
  document.head.appendChild(script);
  
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeChart() {
  document.getElementById('tv-overlay').classList.remove('active');
  document.getElementById('tv-chart-container').innerHTML = '';
  document.body.style.overflow = '';
}

document.getElementById('tv-close').addEventListener('click', closeChart);
document.getElementById('tv-overlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeChart();
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeChart();
});

// ===== HEATMAP =====
function hmColor(val, maxAbs) {
  if (maxAbs === 0) return '#555';
  var ratio = val / maxAbs;
  ratio = Math.max(-1, Math.min(1, ratio));
  if (ratio >= 0) {
    var intensity = ratio;
    var r = Math.round(30 + (1 - intensity) * 55);
    var g = Math.round(100 + intensity * 80);
    var b = Math.round(30 + (1 - intensity) * 55);
    if (intensity > 0.6) { r = Math.round(27); g = Math.round(94 + intensity * 60); b = Math.round(32); }
    else if (intensity > 0.3) { r = Math.round(67); g = Math.round(160); b = Math.round(71); }
    else { r = Math.round(80 + (1 - intensity) * 10); g = Math.round(100 + intensity * 40); b = Math.round(80 + (1 - intensity) * 10); }
    return 'rgb(' + r + ',' + g + ',' + b + ')';
  } else {
    var intensity = -ratio;
    if (intensity > 0.6) return 'rgb(' + Math.round(183) + ',' + Math.round(28) + ',' + Math.round(28) + ')';
    if (intensity > 0.3) return 'rgb(' + Math.round(211) + ',' + Math.round(47) + ',' + Math.round(47) + ')';
    return 'rgb(' + Math.round(140 + intensity * 40) + ',' + Math.round(80 - intensity * 30) + ',' + Math.round(80 - intensity * 30) + ')';
  }
}

function drawHeatmap() {
  var metric = document.getElementById('hm-metric').value;
  var groupBy = document.getElementById('hm-group').value;
  var canvas = document.getElementById('hm-canvas');
  
  // Get data with the chosen metric
  var data = allDataWithSPY.map(function(d) {
    var etfData = allData.find(function(e) { return e.ticker === d.ticker; });
    var val = 0;
    if (metric === 'roc1m') val = d.roc1m;
    else if (metric === 'roc3m') val = d.roc3m;
    else if (metric === 'roc6m') val = d.roc6m;
    else if (metric === 'roc12m') val = d.roc12m;
    else if (etfData) {
      if (metric === 'rsScore') val = etfData.rsScore;
      else if (metric === 'rs1m') val = etfData.rs1m;
      else if (metric === 'rs3m') val = etfData.rs3m;
      else if (metric === 'rs6m') val = etfData.rs6m;
      else if (metric === 'rs12m') val = etfData.rs12m;
      else if (metric === 'pctlScore') val = etfData.pctlScore;
    }
    return {
      ticker: d.ticker,
      cat: d.cat,
      subcat: d.subcat || d.cat,
      val: val,
      absVal: Math.abs(val)
    };
  }).filter(function(d) { return d.ticker && d.ticker !== 'SPY'; });
  
  // Sort by absolute value descending (biggest blocks first)
  data.sort(function(a, b) { return b.absVal - a.absVal; });
  
  // Max for color scaling
  var maxAbs = Math.max.apply(null, data.map(function(d) { return d.absVal; }));
  if (maxAbs === 0) maxAbs = 1;
  
  // Sizing: proportional to absolute value, with min/max
  var minSize = 70;
  var maxSize = 150;
  
  // Group data
  var groups = {};
  if (groupBy === 'none') {
    groups['Todos los ETFs'] = data;
  } else {
    data.forEach(function(d) {
      var key = groupBy === 'cat' ? d.cat : d.subcat;
      if (!key) key = 'Otro';
      if (!groups[key]) groups[key] = [];
      groups[key].push(d);
    });
  }
  
  // Sort groups by average value
  var groupKeys = Object.keys(groups).sort(function(a, b) {
    var avgA = groups[a].reduce(function(s, d) { return s + d.val; }, 0) / groups[a].length;
    var avgB = groups[b].reduce(function(s, d) { return s + d.val; }, 0) / groups[b].length;
    return avgB - avgA;
  });
  
  var html = '';
  groupKeys.forEach(function(group) {
    var items = groups[group];
    html += '<div class="hm-group-section">';
    if (groupBy !== 'none') {
      var avgVal = items.reduce(function(s, d) { return s + d.val; }, 0) / items.length;
      var avgColor = avgVal >= 0 ? 'var(--green-strong)' : 'var(--red)';
      html += '<div class="hm-group-label">' + group + ' <span style="font-family:JetBrains Mono;font-size:0.75rem;color:' + avgColor + '">' + (avgVal >= 0 ? '+' : '') + avgVal.toFixed(2) + '</span></div>';
    }
    html += '<div class="hm-grid">';
    
    items.forEach(function(d) {
      var size = minSize + ((d.absVal / maxAbs) * (maxSize - minSize));
      var bgColor = hmColor(d.val, maxAbs);
      var prefix = d.val > 0 ? '+' : '';
      var displayVal = metric === 'pctlScore' ? d.val.toFixed(1) + '%' : prefix + d.val.toFixed(2);
      
      html += '<div class="hm-cell" style="width:' + size + 'px;height:' + size + 'px;background:' + bgColor + '" onclick="openDetail(\'' + d.ticker + '\')" title="' + d.ticker + ': ' + displayVal + '">';
      html += '<div class="hm-cell-ticker">' + d.ticker + '</div>';
      html += '<div class="hm-cell-val">' + displayVal + '</div>';
      html += '</div>';
    });
    
    html += '</div></div>';
  });
  
  canvas.innerHTML = html;
}

document.getElementById('hm-metric').addEventListener('change', function() { drawHeatmap(); });
document.getElementById('hm-group').addEventListener('change', function() { drawHeatmap(); });

// ===== THEME TOGGLE =====
const toggleBtn = document.getElementById('theme-toggle');
const toggleKnob = document.getElementById('toggle-knob');
function setTheme(theme) {
  document.documentElement.dataset.theme = theme;
  toggleKnob.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('rs-theme', theme);
  // Redraw charts if visible
  if (allData.length) {
    if (document.getElementById('tab-rrg').classList.contains('active')) drawRRG();
    if (document.getElementById('tab-corr').classList.contains('active')) drawCorrelation();
    if (document.getElementById('tab-heatmap').classList.contains('active')) drawHeatmap();
  }
}
toggleBtn.addEventListener('click', () => {
  const current = document.documentElement.dataset.theme || 'dark';
  setTheme(current === 'dark' ? 'light' : 'dark');
});
// Load saved preference
const savedTheme = localStorage.getItem('rs-theme');
if (savedTheme) setTheme(savedTheme);

// ===== INIT =====
fetchData();
setInterval(fetchData, 5*60*1000);
</script>
</body>
</html>
